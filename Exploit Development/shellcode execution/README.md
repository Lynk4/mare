# 🧩 Shellcode Injection

# 🧠 What is Shellcode Injection?

Shellcode injection refers to the technique of inserting a sequence of machine code (shellcode) into a running process's memory space. This shellcode is typically designed to exploit a vulnerability in the process, allowing an attacker to execute arbitrary commands on the target system. Once injected, the shellcode can provide the attacker with unauthorized control over the system, often by spawning a shell (e.g., /bin/sh), executing system commands, or performing other malicious activities.

---


```asm
global _start

section .text

_start:
    jmp string          ; Jump to the string section

code:
    pop rsi             ; Pop the address of "MALWARE INJECTED" into rsi (for write syscall)
    mov al, 1           ; Set the syscall number to 1 (sys_write)
    xor rdi, rdi        ; File descriptor = 0 (stdout)
    add rdi, 1          ; This is just to set rdi to 1 (stdout)
    xor rdx, rdx        ; Reset rdx
    add rdx, 17         ; Length of the string "MALWARE INJECTED\n"
    syscall             ; Perform the write syscall

    xor rax, rax        ; Clear rax register
    add rax, 60         ; Set syscall number to 60 (sys_exit)
    xor rdi, rdi        ; Set rdi to 0 (exit code)
    syscall             ; Perform the exit syscall

string:
    call code           ; Call the code section to execute syscalls
    hacked_str: db 'MALWARE INJECTED', 0xa  ; String to print followed by a newline

```


## 📝 Explanation of hacked.asm

    jmp string: Jumps to the string section where the string is stored.

    code::

        pop rsi: Pops the string pointer (hacked_str) into the rsi register.

        mov al, 1: Sets al to 1, which corresponds to the write syscall.

        xor rdi, rdi and add rdi, 1: Sets rdi to 1, representing standard output (stdout).

        xor rdx, rdx and add rdx, 17: Sets rdx to the length of the string "MALWARE INJECTED\n".

        syscall: Executes the write syscall to print the string to the console.

    exit syscall: Terminates the process gracefully using the exit syscall (syscall 60).

    hacked_str: Contains the string "MALWARE INJECTED\n" that will be printed by the shellcode.


---

## Let's compile the assembly

```bash
lynk@Linux ~/a/shellcode> ls
exploit.c  hacked.asm  hacked_tool.c  r.md
lynk@Linux ~/a/shellcode> nasm -f elf64 hacked.asm -o hacked.o
lynk@Linux ~/a/shellcode> ls
exploit.c  hacked.asm  hacked.o  hacked_tool.c  r.md
lynk@Linux ~/a/shellcode> ld hacked.o -o hacked
lynk@Linux ~/a/shellcode> ls
exploit.c  hacked*  hacked.asm  hacked.o  hacked_tool.c  r.md
lynk@Linux ~/a/shellcode> ./hacked 
MALWARE INJECTED
lynk@Linux ~/a/shellcode> 
```

## Now Convert it to shell code. we will use objdump

Command:

```objdump -M intel -D hacked | grep '[0-9a-f]:' | grep -v 'file' | cut -f2 -d: | cut -f1-7 -d' ' | tr -s ' ' | tr '\t' ' ' | sed 's/ $//g' | sed 's/ /\\\x/g' | paste -d '' -s```


```bash
lynk@Linux ~/a/shellcode> objdump -M intel -D hacked | grep '[0-9a-f]:' | grep -v 'file' | cut -f2 -d: | cut -f1-7 -d' ' | tr -s ' ' | tr '\t' ' ' | sed 's/ $//g' | sed 's/ /\\\x/g' | paste -d '' -s
\xeb\x1f\x5e\xb0\x01\x48\x31\xff\x48\x83\xc7\x01\x48\x31\xd2\x48\x83\xc2\x11\x0f\x05\x48\x31\xc0\x48\x83\xc0\x3c\x48\x31\xff\x0f\x05\xe8\xdc\xff\xff\xff\x4d\x41\x4c\x57\x41\x52\x45\x20\x49\x4e\x4a\x45\x43\x54\x45\x44\x0a
lynk@Linux ~/a/shellcode> 
```

```\xeb\x1f\x5e\xb0\x01\x48\x31\xff\x48\x83\xc7\x01\x48\x31\xd2\x48\x83\xc2\x11\x0f\x05\x48\x31\xc0\x48\x83\xc0\x3c\x48\x31\xff\x0f\x05\xe8\xdc\xff\xff\xff\x4d\x41\x4c\x57\x41\x52\x45\x20\x49\x4e\x4a\x45\x43\x54\x45\x44\x0a```

## 🧰 C Program Runner

exploit.c – Exploit Using Shellcode Injection

This C program demonstrates the concept of shellcode injection by executing a sequence of machine instructions (shellcode) that is embedded within the program. The shellcode will perform a specific operation when executed, in this case, it will print "MALWARE INJECTED" to the screen, just as we saw with the previous shellcode examples.

```c
#include <stdio.h>
#include <string.h>

int main() {

	unsigned char shellcode[] = "\xeb\x1f\x5e\xb0\x01\x48\x31\xff\x48\x83\xc7\x01\x48\x31\xd2\x48\x83\xc2\x11\x0f\x05\x48\x31\xc0\x48\x83\xc0\x3c\x48\x31\xff\x0f\x05\xe8\xdc\xff\xff\xff\x4d\x41\x4c\x57\x41\x52\x45\x20\x49\x4e\x4a\x45\x43\x54\x45\x44\x0a";
	printf("shellcode length : %d\n", (int)strlen(shellcode));
	int (*ret)() = (int(*)())shellcode;
	ret();
}
```

## 🛠️ How to Compile and Run the exploit.c:

To compile and run this exploit on your system:

Compile the Program:

Use the gcc compiler with the -fno-stack-protector and -z execstack flags. 

This is important for disabling certain security mechanisms like stack protection and making the stack executable, which could block shellcode execution.

---
    
```bash
lynk@Linux ~/a/shellcode> ls
hacked*  hacked.asm  hacked.o  hacked_tool.c  r.md
lynk@Linux ~/a/shellcode> gcc -fno-stack-protector -z execstack hacked_tool.c 
lynk@Linux ~/a/shellcode> ls
a.out*  hacked*  hacked.asm  hacked.o  hacked_tool.c  r.md
lynk@Linux ~/a/shellcode> ./a.out 
Legth of shellcode 55
MALWARE INJECTED
lynk@Linux ~/a/shellcode>
```

---
